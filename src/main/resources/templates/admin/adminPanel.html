<!DOCTYPE html>
<html layout:decorator="layout/baselayout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.thymeleaf.org">
<head>
    <title>Admin Panel</title>
    <th:block layout:fragment="styles" />
    <style>
        .optionGroup {
            font-weight: bold;
            font-style: italic;
        }
        .optionChild {
            padding-left: 15px;
        }
    </style>
</head>
<body>

<!--sec:authorize="hasRole('ROLE_ADMIN')"-->

<div layout:fragment="content">

<h1>GO HARD</h1>

<div class="col-xs-4"></div>

<div class="col-xs-4">
    <div class="form-group">

        <label for="users">Users:</label>
        <select class="selectpicker form-control" id="users" name="users" multiple="multiple">
            <option class="optionGroup" th:each="user : ${users}" th:value="${user.username}" th:text="${user.username}"></option>
        </select>
        <br />
        <button class="btn btn-success btn-sm" id="add-user">Add new user</button>
        <button class="btn btn-warning btn-sm" id="redact-user">Redact user</button>
        <button class="btn btn-danger btn-sm" id="delete-user">Delete selected user(s)</button>

        <br />

        <label for="sites">Sites:</label>
        <select class="selectpicker form-control" id="sites" name="sites" multiple="multiple">
            <optgroup th:each="siteHolder : ${siteHolders}" label="------">
                <option class="optionGroup" th:text="${siteHolder.siteHolderName}"></option>
                <option class="optionChild" disabled="disabled" th:each="site : ${siteHolder.sites}" th:text="${site.siteName}"></option>
            </optgroup>
        </select>
        <br />
        <button class="btn btn-success btn-sm" id="add-site">Add new site</button>
        <button class="btn btn-warning btn-sm" id="redact-site">Redact site</button>
        <button class="btn btn-danger btn-sm" id="delete-site">Delete selected site(s)</button>

    </div>
</div>

<div th:replace="admin/elements :: modals"></div>

</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
    /*<![CDATA[*/
// todo: add notification that email must be unique and check it (if not may produce 409 error)
    $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
        jqXHR.setRequestHeader('X-CSRF-Token', [[${_csrf.token}]]);
    });

//    for users

    $('#add-user').on('click', function (e) {
        $('#create-user-modal').modal('show');
    });

    $('#redact-user').on('click', function (e) {
        let userToRedact = $('#users').find(':selected')[0];
        if(!userToRedact) return;
        var modal = $('#create-user-modal');
        var user;
        $.ajax({
            method: 'GET',
            async: false,
            url: '/admin/crud/datarest/users/' + userToRedact.value,
            success: function (response) {
                user = response;
            }
        });
        $('#username').val(userToRedact.value);
        for(let key in user){
            $('#' + key).val(user[key]);
        }
        modal.modal('show');
    });

    $('#delete-user').on('click', function (e) {
        let usersToDelete = $('#users').find(':selected');
        for(let i = 0; i < usersToDelete.length; i++){
            $.ajax({
                method: 'DELETE',
                url: '/admin/crud/datarest/users/' + usersToDelete[i].value
            })
        }
    });

    $('#create-user').on('click', function (e) {
        let userData = collectUserData();
        $.ajax({
            method: 'POST',                        // not PATCH because 1.data prepopulated and if 2.delete field it deleted from DB
            url: '/admin/crud/datarest/users',
            contentType: 'application/json',
            data: JSON.stringify(userData)
        })
    });

    function collectUserData() {
        let userFormData = $('#create-user-data').serializeArray();
        let userData = {};
        $.map(userFormData, function (item) {
            userData[item['name']] = item['value'];
        });
        userData['enabled'] = $('#enabled').is(':checked');
        userData['locked'] = $('#locked').is(':checked');
        return userData;
    }

//    for sites

    $('#add-site').on('click', function (e) {
        $('#create-site-modal').modal('show');
    });

    $('#create-site').on('click', function (e) {
        let siteHolderData = {
            siteHolderName: $('#siteHolderName').val()
        };
        let userData = {
            username: $('#site-creator').val()
        };
        userData = populateUserData(userData);
        siteHolderData.user = getUserLink(userData);
        $.ajax({
            method: 'POST',
            url: '/admin/crud/datarest/siteHolders',
            contentType: 'application/json',
            data: JSON.stringify(siteHolderData)
        });

        function populateUserData(userData) {
            $.ajax({
                method: 'GET',
                async: false,
                url: '/admin/crud/datarest/users/' + userData.username,
                success: function (response) {
                    let username = userData.username;
                    userData = response;
                    userData.username = username;
                    delete userData.authorities;
                },
                statusCode: {
                    404: function() {
                        userData.role = 'ROLE_USER';
                    }
                }
            });
            return userData;
        }

        function getUserLink(userData) {
            let userLink;
            $.ajax({
                method: 'POST',
                async: false,
                url: '/admin/crud/datarest/users',
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function (response) {
                    userLink = response['_links']['self']['href'];
                    console.log(userLink);
                }
            });
            return userLink;
        }

    });

    /*]]>*/
    </script>
</th:block>
</body>
</html>