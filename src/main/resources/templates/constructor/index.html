<!DOCTYPE html>
<html layout:decorator="layout/baselayout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.thymeleaf.org">
<head>
    <title th:text="#{constructor.title}">Constructor</title>
    <th:block layout:fragment="styles">
        <style>
            .my-content{border: thin solid black;}
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="nowrap-content">

    <div class="container">
        <input class="grid-layout" type="image" id="1" th:src="@{/layouts/1.png}" value="[[12]]" checked="checked" />
        <input class="grid-layout" type="image" id="2" th:src="@{/layouts/2.png}" value="[[6,6]]" />
        <input class="grid-layout" type="image" id="3" th:src="@{/layouts/3.png}" value="[[4,8]]" />
        <input class="grid-layout" type="image" id="4" th:src="@{/layouts/4.png}" value="[[12],[6,6],[12]]" />

        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#siteHolder-opts-modal"
                style="float: right;" id="siteHolder-opts">
            <span class="glyphicon glyphicon-cog"></span> Site options
        </button>
        <br />
        <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#site-opts-modal"
                style="float: right;" id="site-opts">
            <span class="glyphicon glyphicon-cog"></span> Page options
        </button>
    </div>
    <div class="container my-toolbar">
        <button type="button" class="my-tool btn btn-default btn-lg" id="tool-font">
            <span class="glyphicon glyphicon-font"></span> Text
        </button>
        <button type="button" class="my-tool btn btn-default btn-lg" id="tool-camera">
            <span class="glyphicon glyphicon-camera"></span> Image
        </button>
        <button type="button" class="my-tool btn btn-default btn-lg" id="tool-film">
            <span class="glyphicon glyphicon-film"></span> Video
        </button>
    </div>

    <div class="container my-container">

    </div>
    <div th:replace="constructor/elements :: modals"></div>

</div>

<th:block layout:fragment="scripts">
    <script type="text/javascript" th:src="@{/js/jquery-ui.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/showdown.min.js}"></script>
    <script type="text/javascript" th:src="@{//widget.cloudinary.com/global/all.js}"></script>
    <script type="text/javascript" th:src="@{/js/work_with_modals.js}"></script>
    <script type="text/javascript" th:src="@{/js/cloudinary_widgets.js}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var siteHolder = {
            sites: [],
            siteHolderName: ''
        };
        var site = {
            images: [],
            texts: [],
            videos: [],
            tags: []
        };

        $('.save-site').on('click', function () {
            var siteName = $('#site-name').get(0);
            var errorDiv = $('.save-site-error').get(0);
            if(!siteName.checkValidity()){
                errorDiv.style.display = 'inline-block';
                errorDiv.innerHTML = '<p>Please, enter page name</p>';
                return;
            }
            if(errorDiv) {errorDiv.remove();}
            var siteOptsModal = $("#site-opts-modal");
            siteOptsModal.modal('hide');
            populateSiteData(site);
            siteHolder.sites.push(site);
            clearSiteData(site);
            clearModal(siteOptsModal);
            renderConstructorPage();
        });

        $('.save-siteHolder').on('click', function () {
            var siteHolderName = $('#siteHolder-name').get(0);
            var errorDiv = $('.save-siteHolder-error').get(0);
            if(!siteHolderName.checkValidity()){
                errorDiv.style.display = 'inline-block';
                errorDiv.innerHTML = '<p>Please, enter site name</p>';
                return;
            }
            $.post('checkSiteHolderNameExist', {
                siteHolderName: siteHolderName.value,
                [[${_csrf.parameterName}]]:[[${_csrf.token}]]
            }, function (exist) {
                if(exist){
                    var errorDiv = $('.save-siteHolder-error').get(0);
                    errorDiv.style.display = 'inline-block';
                    errorDiv.innerHTML = '<p>Site with such name already exist</p>';
                } else {
                    siteHolder.siteHolderName = siteHolderName.value;
                    sendSiteHolderData();
                }
            });
        });

        $('.grid-layout').on('click', function () {
            site.grid = this.value;
        });

        function populateSiteData(site) {
            var siteName = $('#site-name').get(0);
            var container = $('.my-container');
            for(var i = 0; i < container.find('.my-content').length; i++){
                var elements = $('.my-content').eq(i).children('.my-element');
                if(elements.length == 0) {continue;}
                for(var j = 0; j < elements.length; j++){
                    var currentElement = elements.eq(j);
                    if(currentElement.find('.glyphicon-camera').length != 0){
                        currentElement.find('img').each(function (index, image) {
                            site.images.push({url: image.src, position: i});
                        })
                    }
                    if(currentElement.find('.markdown').length != 0){
                        site.texts.push({markdownText: currentElement.find('input').val(), position: i});
                    }
                    if(currentElement.find('iframe').length != 0){
                        var iframe = currentElement.find('iframe');
                        site.videos.push({url: iframe.attr('src'), height: iframe.attr('height'),
                            width: iframe.attr('width'), position: i});
                    }
                }
            }
            site.siteName = siteName.value;
            site.tags = $('#site-tags').value;
            site.theme = $('input[name = "theme"]:checked').val();
            site.allowRating = $('input[name = "allowRating"]').is(':checked');
            site.allowComments = $('input[name = "allowComments"]').is(':checked');
            if(!site.grid) {site.grid = [[12],[6,6],[12]]} // grid which is rendered by default
        }

        function clearSiteData(site) {
            site = {
                images: [],
                texts: [],
                videos: [],
                tags: []
            };
        }

        function sendSiteHolderData() {
            $.post('savesite', {
                siteHolder: JSON.stringify(siteHolder),
                [[${_csrf.parameterName}]]:[[${_csrf.token}]]
            }, function (href) {
                window.location.href = href;
            });
        }
        /*]]>*/
    </script>
</th:block>
</body>
</html>